---
import type { GetStaticPaths, Page } from "astro";
import type { Event } from "src/types/microcms/event";

import UnderPageLayout from "@layouts/UnderPageLayout.astro";
import { client } from "@libs/microcms";
import { Picture } from "@astrojs/image/components";
import FormattedDate from "@components/FormattedDate.svelte";
import Pagination from "@components/Pagination/EventPagination.astro";

export const getStaticPaths: GetStaticPaths = async ({ paginate }) => {
  const { totalCount } = await client.getList<Event>({
    endpoint: "event",
    queries: { limit: 0 },
  });

  return paginate(
    Array.from({ length: totalCount }).map(() => ({})),
    { pageSize: 5 }
  );
};
export interface Props {
  page: Page;
}
const { page } = Astro.props;

const { contents: event } = await client.getList<Event>({
  endpoint: "event",
  queries: {
    limit: 5,
    offset: page.start,
    fields: "id,title,thumbnail,category,createdAt,publishedAt",
  },
});
---

<UnderPageLayout
  mainLabel="EVENT"
  subLabel="マガジン"
  title="マガジン"
  noindex={page.currentPage !== 1}
>
  <ul class="postList">
    {
      event.map(
        ({ id, title, thumbnail, category, createdAt, publishedAt }) => (
          <li>
            <a href={`/event/${id}`} class="flex">
              <div class="thumb">
                <Picture
                  src={thumbnail.url}
                  widths={[320, 640, 960]}
                  aspectRatio={1}
                  width={320}
                  height={320}
                  sizes="20rem"
                  alt=""
                />
              </div>
              <div class="textBox">
                <p class="category">{category}</p>
                <h2 class="title">{title}</h2>

                <FormattedDate class="date" date={publishedAt ?? createdAt} />
              </div>
            </a>
          </li>
        )
      )
    }
  </ul>

  <Pagination class="" page={page} />
</UnderPageLayout>
